<!-- material-search.component.html -->
<div class="relative w-full">
  <div class="relative">
    <div
      class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"
    >
      @if (isLoading()) {
      <svg
        class="h-5 w-5 animate-spin text-neutral-400"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      } @else {
      <svg
        class="h-5 w-5 text-neutral-400"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path
          fill-rule="evenodd"
          d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
          clip-rule="evenodd"
        />
      </svg>
      }
    </div>

    <input
      type="text"
      [value]="searchQuery()"
      (input)="onInput($event)"
      (keydown)="onKeyDown($event)"
      (blur)="onBlur()"
      (focus)="onFocus()"
      placeholder="Search materials..."
      class="block w-full rounded-md border-0 py-2 pl-10 pr-10 text-neutral-900 ring-1 ring-inset ring-neutral-300 placeholder:text-neutral-400 focus:ring-2 focus:ring-inset focus:ring-amber-600 sm:text-sm sm:leading-6"
    />

    @if (searchQuery()) {
    <button
      type="button"
      (click)="clearSearch()"
      class="absolute inset-y-0 right-0 flex items-center pr-3 text-neutral-400 hover:text-neutral-600"
    >
      <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path
          d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"
        />
      </svg>
    </button>
    }
  </div>

  <!-- Dropdown Results -->
  @if (isOpen() && materials().length > 0) {
  <div
    class="absolute z-10 mt-1 w-full rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5"
  >
    <ul
      class="max-h-60 overflow-auto rounded-md py-1 text-base focus:outline-none sm:text-sm"
    >
      @for (material of materials(); track material._id; let i = $index) {
      <li
        (click)="selectMaterial(material)"
        [class.bg-amber-50]="i === selectedIndex()"
        class="relative cursor-pointer select-none py-3 pl-3 pr-9 hover:bg-neutral-50"
      >
        <div class="flex items-start justify-between">
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <span class="font-medium text-neutral-900 truncate">
                {{ material.name }}
              </span>
              @if (material.sku) {
              <span class="text-xs text-neutral-500">
                {{ material.sku }}
              </span>
              }
            </div>

            <div class="mt-1 flex items-center gap-3 text-sm text-neutral-500">
              <span
                >Stock: {{ material.currentStock }}
                {{ material.unit.name || "units" }}</span
              >
              <span
                [class]="getStockStatus(material).class"
                class="font-medium"
              >
                {{ getStockStatus(material).label }}
              </span>
            </div>

            @if (material.category) {
            <div class="mt-1">
              <span
                class="inline-flex items-center rounded-full bg-neutral-100 px-2 py-0.5 text-xs font-medium text-neutral-700"
              >
                {{ material.category }}
              </span>
            </div>
            }
          </div>

          <div class="ml-3 text-right">
            <div class="text-sm font-semibold text-neutral-900">
              Â£{{ material.averageCost.toFixed(2) }}
            </div>
            <div class="text-xs text-neutral-500">per unit</div>
          </div>
        </div>

        @if (i === selectedIndex()) {
        <span
          class="absolute inset-y-0 right-0 flex items-center pr-3 text-amber-600"
        >
          <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path
              fill-rule="evenodd"
              d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z"
              clip-rule="evenodd"
            />
          </svg>
        </span>
        }
      </li>
      }
    </ul>
  </div>
  } @if (isOpen() && materials().length === 0 && !isLoading() &&
  searchQuery().trim().length >= 2) {
  <div
    class="absolute z-10 mt-1 w-full rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5"
  >
    <div class="py-4 px-3 text-center text-sm text-neutral-500">
      No materials found for "{{ searchQuery() }}"
    </div>
  </div>
  }
</div>
